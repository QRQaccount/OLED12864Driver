#include "OLED12864.h"

#define OLED_GPIO_Init()                                                                               \
    GPIO_InitTypeDef GPIO_InitStruct = {0};                                                            \
    __HAL_RCC_GPIOA_CLK_ENABLE();                                                                      \
    HAL_GPIO_WritePin(OLED_CLK_Port, OLED_CLK_GPIO_Pin, GPIO_PIN_RESET);                               \
    HAL_GPIO_WritePin(OLED_DC_Port, OLED_DC_GPIO_Pin, GPIO_PIN_RESET);                                 \
    HAL_GPIO_WritePin(OLED_DI_Port, OLED_DI_GPIO_Pin, GPIO_PIN_RESET);                                 \
    HAL_GPIO_WritePin(OLED_RST_Port, OLED_RST_GPIO_Pin, GPIO_PIN_RESET);                               \
    GPIO_InitStruct.Pin = OLED_CLK_GPIO_Pin | OLED_DC_GPIO_Pin | OLED_DI_GPIO_Pin | OLED_RST_GPIO_Pin; \
    GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;                                                        \
    GPIO_InitStruct.Pull = GPIO_NOPULL;                                                                \
    GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_MEDIUM;                                                    \
    HAL_GPIO_Init(GPIOA, &GPIO_InitStruct);

#define OLED_DC_High() HAL_GPIO_WritePin(OLED_DC_Port, OLED_DC_GPIO_Pin, GPIO_PIN_SET)
#define OLED_DC_Low() HAL_GPIO_WritePin(OLED_DC_Port, OLED_DC_GPIO_Pin, GPIO_PIN_RESET)
#define OLED_DI_High() HAL_GPIO_WritePin(OLED_DI_Port, OLED_DI_GPIO_Pin, GPIO_PIN_SET)
#define OLED_DI_Low() HAL_GPIO_WritePin(OLED_DI_Port, OLED_DI_GPIO_Pin, GPIO_PIN_RESET)
#define OLED_RST_High() HAL_GPIO_WritePin(OLED_RST_Port, OLED_RST_GPIO_Pin, GPIO_PIN_SET)
#define OLED_RST_Low() HAL_GPIO_WritePin(OLED_RST_Port, OLED_RST_GPIO_Pin, GPIO_PIN_RESET)
#define OLED_CLK_High() HAL_GPIO_WritePin(OLED_CLK_Port, OLED_CLK_GPIO_Pin, GPIO_PIN_SET)
#define OLED_CLK_Low() HAL_GPIO_WritePin(OLED_CLK_Port, OLED_CLK_GPIO_Pin, GPIO_PIN_RESET)

// 根据不同库使用ms级延时
#define OLED_CLK_Delay_ms(x) HAL_Delay(x)
// 该语句宏仅用于CLK信号的延时
// 需要更加精细的控制请自行更换延时函数
#define OLED_CLK_Delay asm("nop")

#define X_WIDTH 128 // x轴宽度
#define Y_HEIGHT 64 // y轴高度

#if IS_GLOBAL_REFRESH == 1
// OLED12864点阵图像
uint8_t image_array[128][64];
#endif

// 大小为6*8的字符
const unsigned char ascii_6x8[][6] =
    {
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // sp
        {0x00, 0x00, 0x00, 0x2f, 0x00, 0x00}, // !
        {0x00, 0x00, 0x07, 0x00, 0x07, 0x00}, // "
        {0x00, 0x14, 0x7f, 0x14, 0x7f, 0x14}, // #
        {0x00, 0x24, 0x2a, 0x7f, 0x2a, 0x12}, // $
        {0x00, 0x62, 0x64, 0x08, 0x13, 0x23}, // %
        {0x00, 0x36, 0x49, 0x55, 0x22, 0x50}, // &
        {0x00, 0x00, 0x05, 0x03, 0x00, 0x00}, // '
        {0x00, 0x00, 0x1c, 0x22, 0x41, 0x00}, // (
        {0x00, 0x00, 0x41, 0x22, 0x1c, 0x00}, // )
        {0x00, 0x14, 0x08, 0x3E, 0x08, 0x14}, // *
        {0x00, 0x08, 0x08, 0x3E, 0x08, 0x08}, // +
        {0x00, 0x00, 0x00, 0xA0, 0x60, 0x00}, // ,
        {0x00, 0x08, 0x08, 0x08, 0x08, 0x08}, // -
        {0x00, 0x00, 0x60, 0x60, 0x00, 0x00}, // .
        {0x00, 0x20, 0x10, 0x08, 0x04, 0x02}, // /
        {0x00, 0x3E, 0x51, 0x49, 0x45, 0x3E}, // 0
        {0x00, 0x00, 0x42, 0x7F, 0x40, 0x00}, // 1
        {0x00, 0x42, 0x61, 0x51, 0x49, 0x46}, // 2
        {0x00, 0x21, 0x41, 0x45, 0x4B, 0x31}, // 3
        {0x00, 0x18, 0x14, 0x12, 0x7F, 0x10}, // 4
        {0x00, 0x27, 0x45, 0x45, 0x45, 0x39}, // 5
        {0x00, 0x3C, 0x4A, 0x49, 0x49, 0x30}, // 6
        {0x00, 0x01, 0x71, 0x09, 0x05, 0x03}, // 7
        {0x00, 0x36, 0x49, 0x49, 0x49, 0x36}, // 8
        {0x00, 0x06, 0x49, 0x49, 0x29, 0x1E}, // 9
        {0x00, 0x00, 0x36, 0x36, 0x00, 0x00}, // :
        {0x00, 0x00, 0x56, 0x36, 0x00, 0x00}, // ;
        {0x00, 0x08, 0x14, 0x22, 0x41, 0x00}, // <
        {0x00, 0x14, 0x14, 0x14, 0x14, 0x14}, // =
        {0x00, 0x00, 0x41, 0x22, 0x14, 0x08}, // >
        {0x00, 0x02, 0x01, 0x51, 0x09, 0x06}, // ?
        {0x00, 0x32, 0x49, 0x59, 0x51, 0x3E}, // @
        {0x00, 0x7C, 0x12, 0x11, 0x12, 0x7C}, // A
        {0x00, 0x7F, 0x49, 0x49, 0x49, 0x36}, // B
        {0x00, 0x3E, 0x41, 0x41, 0x41, 0x22}, // C
        {0x00, 0x7F, 0x41, 0x41, 0x22, 0x1C}, // D
        {0x00, 0x7F, 0x49, 0x49, 0x49, 0x41}, // E
        {0x00, 0x7F, 0x09, 0x09, 0x09, 0x01}, // F
        {0x00, 0x3E, 0x41, 0x49, 0x49, 0x7A}, // G
        {0x00, 0x7F, 0x08, 0x08, 0x08, 0x7F}, // H
        {0x00, 0x00, 0x41, 0x7F, 0x41, 0x00}, // I
        {0x00, 0x20, 0x40, 0x41, 0x3F, 0x01}, // J
        {0x00, 0x7F, 0x08, 0x14, 0x22, 0x41}, // K
        {0x00, 0x7F, 0x40, 0x40, 0x40, 0x40}, // L
        {0x00, 0x7F, 0x02, 0x0C, 0x02, 0x7F}, // M
        {0x00, 0x7F, 0x04, 0x08, 0x10, 0x7F}, // N
        {0x00, 0x3E, 0x41, 0x41, 0x41, 0x3E}, // O
        {0x00, 0x7F, 0x09, 0x09, 0x09, 0x06}, // P
        {0x00, 0x3E, 0x41, 0x51, 0x21, 0x5E}, // Q
        {0x00, 0x7F, 0x09, 0x19, 0x29, 0x46}, // R
        {0x00, 0x46, 0x49, 0x49, 0x49, 0x31}, // S
        {0x00, 0x01, 0x01, 0x7F, 0x01, 0x01}, // T
        {0x00, 0x3F, 0x40, 0x40, 0x40, 0x3F}, // U
        {0x00, 0x1F, 0x20, 0x40, 0x20, 0x1F}, // V
        {0x00, 0x3F, 0x40, 0x38, 0x40, 0x3F}, // W
        {0x00, 0x63, 0x14, 0x08, 0x14, 0x63}, // X
        {0x00, 0x07, 0x08, 0x70, 0x08, 0x07}, // Y
        {0x00, 0x61, 0x51, 0x49, 0x45, 0x43}, // Z
        {0x00, 0x00, 0x7F, 0x41, 0x41, 0x00}, // [
        {0x00, 0x55, 0x2A, 0x55, 0x2A, 0x55}, // 55
        {0x00, 0x00, 0x41, 0x41, 0x7F, 0x00}, // ]
        {0x00, 0x04, 0x02, 0x01, 0x02, 0x04}, // ^
        {0x00, 0x40, 0x40, 0x40, 0x40, 0x40}, // _
        {0x00, 0x00, 0x01, 0x02, 0x04, 0x00}, // '
        {0x00, 0x20, 0x54, 0x54, 0x54, 0x78}, // a
        {0x00, 0x7F, 0x48, 0x44, 0x44, 0x38}, // b
        {0x00, 0x38, 0x44, 0x44, 0x44, 0x20}, // c
        {0x00, 0x38, 0x44, 0x44, 0x48, 0x7F}, // d
        {0x00, 0x38, 0x54, 0x54, 0x54, 0x18}, // e
        {0x00, 0x08, 0x7E, 0x09, 0x01, 0x02}, // f
        {0x00, 0x18, 0xA4, 0xA4, 0xA4, 0x7C}, // g
        {0x00, 0x7F, 0x08, 0x04, 0x04, 0x78}, // h
        {0x00, 0x00, 0x44, 0x7D, 0x40, 0x00}, // i
        {0x00, 0x40, 0x80, 0x84, 0x7D, 0x00}, // j
        {0x00, 0x7F, 0x10, 0x28, 0x44, 0x00}, // k
        {0x00, 0x00, 0x41, 0x7F, 0x40, 0x00}, // l
        {0x00, 0x7C, 0x04, 0x18, 0x04, 0x78}, // m
        {0x00, 0x7C, 0x08, 0x04, 0x04, 0x78}, // n
        {0x00, 0x38, 0x44, 0x44, 0x44, 0x38}, // o
        {0x00, 0xFC, 0x24, 0x24, 0x24, 0x18}, // p
        {0x00, 0x18, 0x24, 0x24, 0x18, 0xFC}, // q
        {0x00, 0x7C, 0x08, 0x04, 0x04, 0x08}, // r
        {0x00, 0x48, 0x54, 0x54, 0x54, 0x20}, // s
        {0x00, 0x04, 0x3F, 0x44, 0x40, 0x20}, // t
        {0x00, 0x3C, 0x40, 0x40, 0x20, 0x7C}, // u
        {0x00, 0x1C, 0x20, 0x40, 0x20, 0x1C}, // v
        {0x00, 0x3C, 0x40, 0x30, 0x40, 0x3C}, // w
        {0x00, 0x44, 0x28, 0x10, 0x28, 0x44}, // x
        {0x00, 0x1C, 0xA0, 0xA0, 0xA0, 0x7C}, // y
        {0x00, 0x44, 0x64, 0x54, 0x4C, 0x44}, // z
        {0x14, 0x14, 0x14, 0x14, 0x14, 0x14}  // horiz lines
};

// 写入数据
void OLED_Write_Data(unsigned char data)
{
    // 字长
    uint8_t word = 8;
    OLED_DC_High();
    OLED_CLK_Delay;
    OLED_CLK_Low();
    OLED_CLK_Delay;
    while (word--)
    {
        if (data & 0x80)
        {
            OLED_DI_High();
        }
        else
        {
            OLED_DI_Low();
            OLED_CLK_Delay;
        }
        OLED_CLK_High();
        OLED_CLK_Delay;
        for (uint8_t i = 0; i < 1; i++)
        {
            OLED_CLK_Delay;
        }
        OLED_CLK_Low();
        OLED_CLK_Delay;
        data <<= 1;
    }
}

// 写入命令
void OLED_Write_Cmd(unsigned char cmd)
{
    uint8_t word = 8;
    OLED_DC_Low();
    OLED_CLK_Delay;
    OLED_CLK_Low();
    while (word--)
    {
        if (cmd & 0x80)
        {
            OLED_DI_High();
        }
        else
        {
            OLED_DI_Low();
            OLED_CLK_Delay;
        }
        OLED_CLK_High();
        OLED_CLK_Delay;
        for (uint8_t i = 0; i < 1; i++)
        {
            OLED_CLK_Delay;
        }
        OLED_CLK_Low();
        OLED_CLK_Delay;
        cmd <<= 1;
    }
}

// 设置此时指向的点
void OLED_Set_Pointer(uint8_t x, uint8_t y)
{
    OLED_Write_Cmd(0xb0 + y);
    OLED_Write_Cmd((x & 0xf0) >> 4 | 0x10);
    OLED_Write_Cmd((x & 0x0f) | 0x01);
}

void OLED_Fill(unsigned char data)
{
    uint8_t x, y;
    for (y = 0; y < 8; y++)
    {
        OLED_Write_Cmd(0xb0 + y);
        OLED_Write_Cmd(0x01);
        OLED_Write_Cmd(0x10);
        for (x = 0; x < X_WIDTH; x++)
        {
            OLED_Write_Data(data);
        }
    }
}

void OLED_Init(void)
{
    OLED_GPIO_Init();
    OLED_CLK_High();
    OLED_RST_Low();
    OLED_CLK_Delay_ms(50);
    OLED_RST_High();

    OLED_Write_Cmd(0xae); //--turn off oled panel
    OLED_Write_Cmd(0x00); //---set low column address
    OLED_Write_Cmd(0x10); //---set high column address
    OLED_Write_Cmd(0x40); //--set start line address  Set Mapping RAM Display Start Line (0x00~0x3F)
    OLED_Write_Cmd(0x81); //--set contrast control register
    OLED_Write_Cmd(0xcf); // Set SEG Output Current Brightness
    OLED_Write_Cmd(0xa1); //--Set SEG/Column Mapping     0xa0左右反置 0xa1正常
    OLED_Write_Cmd(0xc8); //Set COM/Row Scan Direction   0xc0上下反置 0xc8正常
    OLED_Write_Cmd(0xa6); //--set normal display
    OLED_Write_Cmd(0xa8); //--set multiplex ratio(1 to 64)
    OLED_Write_Cmd(0x3f); //--1/64 duty
    OLED_Write_Cmd(0xd3); //-set display offset	Shift Mapping RAM Counter (0x00~0x3F)
    OLED_Write_Cmd(0x00); //-not offset
    OLED_Write_Cmd(0xd5); //--set display clock divide ratio/oscillator frequency
    OLED_Write_Cmd(0x80); //--set divide ratio, Set Clock as 100 Frames/Sec
    OLED_Write_Cmd(0xd9); //--set pre-charge period
    OLED_Write_Cmd(0xf1); //Set Pre-Charge as 15 Clocks & Discharge as 1 Clock
    OLED_Write_Cmd(0xda); //--set com pins hardware configuration
    OLED_Write_Cmd(0x12);
    OLED_Write_Cmd(0xdb); //--set vcomh
    OLED_Write_Cmd(0x40); //Set VCOM Deselect Level
    OLED_Write_Cmd(0x20); //-Set Page Addressing Mode (0x00/0x01/0x02)
    OLED_Write_Cmd(0x02); //
    OLED_Write_Cmd(0x8d); //--set Charge Pump enable/disable
    OLED_Write_Cmd(0x14); //--set(0x10) disable
    OLED_Write_Cmd(0xa4); // Disable Entire Display On (0xa4/0xa5)
    OLED_Write_Cmd(0xa6); // Disable Inverse Display On (0xa6/a7)
    OLED_Write_Cmd(0xaf); //--turn on oled panel
    OLED_Fill(0x00);      //初始清屏

    OLED_Set_Pointer(0, 0);
}

void OLED_DrawPoint(OLED_Point point)
{
    uint8_t value;

    OLED_Set_Pointer(point.x, point.y >> 3);
    value = (0x01 << (point.y % 8));
    OLED_Write_Cmd((0xb0 + (point.y >> 3)));
    OLED_Write_Cmd(((point.x & 0xf0) >> 4) | 0x10);
    OLED_Write_Cmd((point.x & 0x0f) | 0x00);
    OLED_Write_Data(value);
}

void OLED_DrawCharacter(char character, OLED_Point start_point, FontSize font_size)
{
    switch (font_size)
    {
    case small:
        break;
    case big:
        break;
    default:
        break;
    }
}

void OLED_DrawString(const char str[], OLED_Point start_point, FontSize font_size)
{
    uint32_t index, col_index;
    uint8_t charater_index;
    switch (font_size)
    {
    case small:
        while (str[index] != '\0')
        {
            // 将字符与字体库中的字对应
            charater_index = str[index] - 32;
            if (start_point.x > 126)
            {
                start_point.x = 0;
                start_point.y++;
            }
            OLED_Set_Pointer(start_point.x, start_point.y);
            for (col_index = 0; col_index < 6; col_index++)
            {
                OLED_Write_Data(ascii_6x8[charater_index][col_index]);
            }
            start_point.x += 6;
            index++;
        }

        break;
    case big:
        break;
    default:
        break;
    }
}
